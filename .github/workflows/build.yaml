name: Build and Release Linux

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Install CMake and build essentials
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      - name: Configure and Build
        run: |
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release --parallel $(nproc)

      - name: Package Artifacts (create folder with includes + libs and archive it)
        run: |
          set -euo pipefail
          rm -rf artifact-linux release-archive-*.tar.gz
          mkdir -p artifact-linux/include

          # copy headers (if any)
          if [ -d include ]; then
            cp -r include/* artifact-linux/include/ || true
          fi

          # copy static libs
          find build -name "*.a" -exec cp --parents {} artifact-linux/ \; || true

          # sanity list
          echo "artifact-linux contents:"
          find artifact-linux -maxdepth 3 -type f -print

          # create single tar.gz archive named with tag (github.ref_name available at runtime)
          ARCH_NAME="tokenizers-cpp-linux-${{ github.ref_name }}.tar.gz"
          tar -C artifact-linux -czf "${ARCH_NAME}" .
          echo "Created archive: ${ARCH_NAME}"
          ls -lh "${ARCH_NAME}"

      - name: Upload build artifact (single archive)
        if: ${{ !env.ACT }}
        uses: actions/upload-artifact@v4
        with:
          name: tokenizers-cpp-linux
          path: tokenizers-cpp-linux-${{ github.ref_name }}.tar.gz

  create-release:
    needs: build-linux
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: tokenizers-cpp-linux
          path: ./release-artifact

      - name: Inspect downloaded artifact
        run: |
          echo "downloaded files:"
          ls -lh ./release-artifact || true
          find ./release-artifact -maxdepth 2 -type f -print || true

      - name: Create GitHub Release (attach the single archive)
        uses: softprops/action-gh-release@v1
        with:
          files: ./release-artifact/*.tar.gz
          generate_release_notes: true